<!DOCTYPE html>
<html>

<head>
    <title>Local Posters Plugin Configuration</title>
</head>

<body>
<div data-role="page" class="page type-interior pluginConfigurationPage tbsConfigurationPage"
     data-require="emby-input,emby-button">
    <div data-role="content">
        <div class="content-primary">
            <form class="tbsConfigurationPage">
                <div class="sectionTitleContainer flex align-items-center">
                    <h2 class="sectionTitle">Local Posters Configuration</h2>
                </div>
                <div class="verticalSection">
                    <p>Manage the folder paths for your local posters. You can add or remove folders.</p>
                    <br/>
                </div>

                <!-- Folder List -->
                <div class="folders">
                    <div style="display: flex; align-items: center;">
                        <h1>Folders</h1>
                        <button is="emby-button" type="button" class="fab btnAddFolder submit emby-button" title="Add"
                                onclick="toggleFolderInput()">
                            <span class="material-icons add" aria-hidden="true"></span>
                        </button>
                    </div>

                    <div id="folderInputContainer" style="display: none; margin-top: 10px;">
                        <input type="text" id="newFolder" class="emby-input" placeholder="Enter folder path">
                        <button is="emby-button" type="button" class="raised button-submit emby-button"
                                onclick="addFolder()">
                            <span>Add</span>
                        </button>
                    </div>

                    <div id="divFolders" class="paperList folderList" style="margin-bottom:2em">

                    </div>
                </div>

                <button is="emby-button" type="button" class="raised button-submit block emby-button"
                        id="saveFoldersButton" onclick="save()">
                    <span>Save</span>
                </button>
            </form>
        </div>
    </div>

    <script type="text/javascript">
        var pluginId = "3938fe98-b7b2-4333-b678-c4c4e339d232";
        var config = {Folders: []};

        ApiClient.getPluginConfiguration(pluginId).then(function (savedConfig) {
            if (savedConfig) {
                config = savedConfig;
            }
            loadFolders();
        });

        function loadFolders() {
            var page = $.mobile.activePage;
            var html = '';

            config.Folders.forEach(function (folder, index) {
                html += '<div class="listItem listItem-border lnkPath" data-index="' + index + '">' +
                    '<div class="listItemBody">' +
                    '<h3 class="listItemBodyText">' + folder + '</h3>' +
                    '</div>' +
                    '<button type="button" is="paper-icon-button-light" class="listItemButton btnRemovePath paper-icon-button-light" data-index="' + index + '" onclick="removeFolder(' + index + ')" title="Remove">' +
                    '<span class="material-icons remove_circle" aria-hidden="true"></span>' +
                    '</button>' +
                    '</div>';
            });

            $('#divFolders', page).html(html).trigger('create');
        }

        // Open the DirectoryBrowser component
        function openDirectoryBrowser() {
            // Assuming DirectoryBrowser is globally available after the import
            var directoryBrowser = new DirectoryBrowser({
                onFolderSelect: function(folderPath) {
                    if (folderPath && !config.Folders.includes(folderPath)) {
                        config.Folders.push(folderPath);
                        loadFolders();
                    }
                }
            });
            directoryBrowser.open();
        }

        function addFolder() {
            var folderInput = $('#newFolder').val().trim();
            if (folderInput && !config.Folders.includes(folderInput)) {
                config.Folders.push(folderInput);
                $('#newFolder').val('');
                loadFolders(); // Update UI, but do not save yet
            }
        }

        function removeFolder(index) {
            if (config.Folders[index]) {
                config.Folders.splice(index, 1);
                loadFolders(); // Update UI, but do not save yet
            }
        }

        function save() {
            ApiClient.updatePluginConfiguration(pluginId, config).then(function (res) {
                Dashboard.alert("Configuration Updated Successfully");
            }).catch(function (err) {
                Dashboard.alert({
                    message: "Unexpected error occurred!"
                });
            });
        }
    </script>
</div>
</body>

</html>
